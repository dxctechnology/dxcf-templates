AWSTemplateFormatVersion: 2010-09-09
Description: Utility-WindowsBastions Template.
  This adds Windows Bastions to a VPC. These Bastions are wrapped in an AutoScalingGroup, so if they fail, they are re-created automatically. Optionally, static
  public and private IP addresses can be requested, and optionally registered in public and private DNS. Optionally, logs can be uploaded to CloudWatch Logs,
  with an Alarm to monitor invalid users.
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Stack Dependencies
        Parameters:
          - DirectoryStackName
          - VPCStackName
          - AMIFunctionsStackName
          - BucketsStackName
          - TopicsStackName
          - CodesStackName
      - Label:
          default: Resource Dependencies
        Parameters:
          - KeyName
      - Label:
          default: System Configuration
        Parameters:
          - CompanyName
          - SystemName
      - Label:
          default: Environment Configuration
        Parameters:
          - AccountName
          - EnvironmentName
          - EnvironmentType
          - EnvironmentZones
          - OSName
      - Label:
          default: Utility Dependencies Configuration
        Parameters:
          - AwsCliProductObject
          - ChromeProductObject
          - RoyalTSProductObject
          - PuTTYProductObject
      - Label:
          default: Utility Configuration
        Parameters:
          - UtilityName
          - UtilityDomain
          - UseStaticPublicAddress
          - UseFedRAMP
          - LogRetention
          - OnSchedule
          - OffSchedule
      - Label:
          default: Directory Configuration
        Parameters:
          - DirectoryAdministratorPassword
      - Label:
          default: Security Configuration
        Parameters:
          - UserNetworks
          - UserNetworkDescriptions
    ParameterLabels:
      ActiveDirectoryStackName:
        default: Active Directory Stack Name
      VPCStackName:
        default: VPC Stack Name
      AMIFunctionsStackName:
        default: AMIFunctions Stack Name
      BucketsStackName:
        default: Buckets Stack Name
      TopicsStackName:
        default: Topics Stack Name
      CodesStackName:
        default: Codes Stack Name
      KeyName:
        default: Key Name
      CompanyName:
        default: Company Name
      SystemName:
        default: System Name
      AccountName:
        default: Account Name
      EnvironmentName:
        default: Environment Name
      EnvironmentType:
        default: Environment Type
      EnvironmentZones:
        default: Environment Zones
      OSName:
        default: Operating System Name
      AwsCliProductObject:
        default: AWS CLI Product Object
      ChromeProductObject:
        default: Chrome Product Object
      RoyalTSProductObject:
        default: RoyalTS Product Object
      PuTTYProductObject:
        default: PuTTY Product Object
      UtilityName:
        default: Utility Name
      UtilityDomain:
        default: Utility Domain
      UseStaticPublicAddress:
        default: Use Static Public Address
      UseFedRAMP:
        default: Harden for FedRAMP Security Standards
      LogRetention:
        default: Log Retention
      OnSchedule:
        default: On Schedule
      OffSchedule:
        default: Off Schedule
      DirectoryAdministratorPassword:
        default: Directory Administrator Password
      UserNetworks:
        default: User Networks
      UserNetworkDescriptions:
        default: User Network Descriptions
Parameters:
  DirectoryStackName:
    Description: Name of the CloudFormation Stack containing the Directory Management Workstation (DirectoryService) or DomainControllers (ActiveDirectory)
    Type: String
    MaxLength: 64
    Default: Production-DirectoryService
    AllowedPattern: ^[A-Z][a-zA-Z0-9]*-(ActiveDirectory|DirectoryService)$
    ConstraintDescription: must begin with an upper case letter and contain alphanumeric characters and dashes.
  VPCStackName:
    Description: Name of the CloudFormation Stack containing the VPC
    Type: String
    MinLength: 2
    MaxLength: 64
    Default: Production-VPC
    AllowedPattern: ^[A-Z][-a-zA-Z0-9]*$
    ConstraintDescription: must begin with an upper case letter and contain alphanumeric characters and dashes.
  AMIFunctionsStackName:
    Description: Name of the CloudFormation Stack containing the AMI Functions
    Type: String
    MinLength: 2
    MaxLength: 64
    Default: AMIFunctions
    AllowedPattern: ^[A-Z][-a-zA-Z0-9]*$
    ConstraintDescription: must begin with an upper case letter and contain alphanumeric characters and dashes.
  BucketsStackName:
    Description: Name of the CloudFormation Stack containing Buckets
    Type: String
    MinLength: 2
    MaxLength: 64
    Default: Buckets
    AllowedPattern: ^[A-Z][-a-zA-Z0-9]*$
    ConstraintDescription: must begin with an upper case letter and contain alphanumeric characters and dashes.
  TopicsStackName:
    Description: Name of the CloudFormation Stack containing Topics
    Type: String
    MinLength: 2
    MaxLength: 64
    Default: Topics
    AllowedPattern: ^[A-Z][-a-zA-Z0-9]*$
    ConstraintDescription: must begin with an upper case letter and contain alphanumeric characters and dashes.
  CodesStackName:
    Description: Name of the CloudFormation Stack containing the Codes Resources
    Type: String
    MinLength: 2
    MaxLength: 64
    Default: Codes
    AllowedPattern: ^[A-Z][-a-zA-Z0-9]*$
    ConstraintDescription: must begin with an upper case letter and contain alphanumeric characters and dashes.
  KeyName:
    Description: Name of an existing KeyPair to enable the Administrator Password
    Type: AWS::EC2::KeyPair::KeyName
    MaxLength: 32
    Default: example
    AllowedPattern: (^$|^[_a-zA-Z0-9]*$)
    ConstraintDescription: must be the name of an existing EC2 KeyPair.
  CompanyName:
    Description: Name of the Company associated with the Stack
    Type: String
    MinLength: 2
    MaxLength: 32
    Default: DXC
    AllowedPattern: ^[A-Z][a-zA-Z0-9]*$
    ConstraintDescription: must begin with an upper case letter and contain alphanumeric characters.
  SystemName:
    Description: Name of the System associated with the Stack
    Type: String
    MinLength: 2
    MaxLength: 32
    Default: Prototype
    AllowedPattern: ^[A-Z][a-zA-Z0-9]*$
    ConstraintDescription: must begin with an upper case letter and contain alphanumeric characters.
  AccountName:
    Description: Name of the Account associated with the Stack
    Type: String
    Default: Production
    AllowedValues:
      - Production
      - Staging
      - UAT
      - QA
      - Testing
      - Development
      - Build
      - Core
      - Recovery
      - Log
      - Management
      - Jumpstart
      - Organization
    ConstraintDescription: must be Production, Staging, UAT, QA, Testing, Development, Build, Core, Recovery, Log, Management, Jumpstart or Organization.
  EnvironmentName:
    Description: Name of the Environment associated with the Stack
    Type: String
    Default: Production
    AllowedValues:
      - Production
      - Staging
      - UAT
      - QA
      - Testing
      - Development
      - Build
      - Core
      - Recovery
      - Log
      - Identity
      - Management
      - Organization
    ConstraintDescription: must be Production, Staging, UAT, QA, Testing, Development, Build, Core, Recovery, Log, Identity, Management or Organization.
  EnvironmentType:
    Description: Type of the Environment to build. Used to select size-related options in Mappings
    Type: String
    Default: small
    AllowedValues:
      - standby
      - small
      - medium
      - large
      - xlarge
      - 2xlarge
    ConstraintDescription: must be standby, small, medium, large, xlarge or 2xlarge.
  EnvironmentZones:
    Description: Number of Availability Zones to build
    Type: String
    Default: 1
    AllowedValues:
      - 1
      - 2
    ConstraintDescription: must be 1 or 2.
  OSName:
    Description: The Operating System to use for Instances
    Type: String
    Default: Windows Server 2012 R2
    AllowedValues:
      - Windows Server 2012 R2
      - Windows Server 2016
    ConstraintDescription: must be "Windows Server 2012 R2" or "Windows Server 2016".
  AwsCliProductObject:
    Description: Object within the S3 bucket and folder containing the AWS CLI installer
    Type: String
    MaxLength: 64
    Default: ''
    AllowedPattern: (^$|^[-_.a-zA-Z0-9]*$)
    ConstraintDescription: must be a valid filename, not containing slashes.
  ChromeProductObject:
    Description: Object within the S3 bucket and folder containing the Chrome installer
    Type: String
    MaxLength: 64
    Default: ''
    AllowedPattern: (^$|^[-_.a-zA-Z0-9]*$)
    ConstraintDescription: must be a valid filename, not containing slashes.
  RoyalTSProductObject:
    Description: Object within the S3 bucket and folder containing the RoyalTS installer
    Type: String
    MaxLength: 64
    Default: ''
    AllowedPattern: (^$|^[-_.a-zA-Z0-9]*$)
    ConstraintDescription: must be a valid filename, not containing slashes.
  PuTTYProductObject:
    Description: Object within the S3 bucket and folder containing the PuTTY installer
    Type: String
    MaxLength: 64
    Default: ''
    AllowedPattern: (^$|^[-_.a-zA-Z0-9]*$)
    ConstraintDescription: must be a valid filename, not containing slashes.
  UtilityName:
    Description: Name of the Utility associated with the Stack
    Type: String
    MinLength: 2
    MaxLength: 32
    Default: WindowsBastions
    AllowedPattern: ^[A-Z][a-zA-Z0-9]*$
    ConstraintDescription: must begin with an upper case letter and contain alphanumeric characters.
  UtilityDomain:
    Description: DNS Name of the Utility associated with the Stack
    Type: String
    MaxLength: 16
    Default: wbastion
    AllowedPattern: (^$|^[a-z][-a-z0-9]*$)
    ConstraintDescription: must begin with a lower case letter and contain only lower case letters, numbers and dashes.
  UseStaticPublicAddress:
    Description: Create and associate a separate Static Public Address
    Type: String
    Default: true
    AllowedValues:
      - true
      - false
    ConstraintDescription: must be either true or false.
  UseFedRAMP:
    Description: Harden Bastions for FedRAMP Security Standards
    Type: String
    Default: false
    AllowedValues:
      - true
      - false
    ConstraintDescription: must be either true or false.
  LogRetention:
    Description: Number of days to retain CloudWatch Log Events
    Type: Number
    Default: 14
    AllowedValues:
      - 1
      - 3
      - 5
      - 7
      - 14
      - 30
      - 60
      - 90
      - 120
      - 150
      - 180
      - 365
      - 400
      - 545
      - 731
      - 1827
      - 3653
    ConstraintDescription: must be 1, 3, 5, 7, 14, 30, 60, 90, 120, 150, 180, 365, 400, 545, 731, 1827 or 3653.
  OnSchedule:
    Description: On Schedule in constrained Cron format (UTC)
    Type: String
    Default: 0 11 * * 1-5
    AllowedPattern: (^$|^0 ([5-9]|1[0-6]) \* \* 1-5$)
    ConstraintDescription: 'must follow constrained cron syntax: "0 H * * 1-5", where H = 5-16.'
  OffSchedule:
    Description: Off Schedule in constrained Cron format (UTC)
    Type: String
    Default: 0 4 * * *
    AllowedPattern: (^$|^0 [0-7] \* \* \*$)
    ConstraintDescription: 'must follow constrained cron syntax: "0 H * * *", where H = 0-7.'
  DirectoryAdministratorPassword:
    Description: Optional password for the Enterprise Admin User (If unspecified, value obtained via Secret)
    Type: String
    NoEcho: true
    Default: ''
    AllowedPattern: (^$|(?=^.{20,64}$)(^[a-z]{4,32}(-[a-z]{4,32}){2,7}$|(?=.*[A-Z])(?=.*[a-z])(?=.*[0-9])^.*))
    ConstraintDescription: must be 20 to 64 alphanumeric characters, in either hyphenated multiword format,
      or random string format with at least one uppercase, lowercase and digit, if specified.
  UserNetworks:
    Description: Networks that can use the Utility
    Type: String
    Default: -,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-
    ConstraintDescription: must be a comma-separated list of 16 values, each an IP CIDR range of the form x.x.x.x/x or '-'.
  UserNetworkDescriptions:
    Description: Descriptions of networks that can use the Utility
    Type: String
    Default: -,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-
    ConstraintDescription: must be a comma-separated list of 16 values, each a short text description or '-'.
Mappings:
  RegionNameMap:
    us-east-1:
      Name: Virginia
      Code: ue1
    us-east-2:
      Name: Ohio
      Code: ue2
    us-west-1:
      Name: California
      Code: uw1
    us-west-2:
      Name: Oregon
      Code: uw2
    ap-east-1:
      Name: HongKong
      Code: ae1
    ap-south-1:
      Name: Mumbai
      Code: ad1
    ap-northeast-2:
      Name: Seoul
      Code: an2
    ap-southeast-1:
      Name: Singapore
      Code: as1
    ap-southeast-2:
      Name: Sydney
      Code: as2
    ap-northeast-1:
      Name: Tokyo
      Code: an1
    ca-central-1:
      Name: Canada
      Code: cc1
    eu-central-1:
      Name: Frankfurt
      Code: ec1
    eu-west-1:
      Name: Ireland
      Code: ew1
    eu-west-2:
      Name: London
      Code: ew2
    eu-west-3:
      Name: Paris
      Code: ew3
    eu-north-1:
      Name: Stockholm
      Code: en1
    me-south-1:
      Name: Bahrain
      Code: ms1
    sa-east-1:
      Name: SaoPaulo
      Code: se1
  InstanceTypeMap:
    Bastion:
      standby: t3.small
      small: t3.small
      medium: t3.medium
      large: m5.large
      xlarge: m5.xlarge
      2xlarge: m5.2xlarge
Conditions:
  ConfigureAccountEnvironment: !Or [ !Not [ !Equals [ !Ref AccountName, !Ref EnvironmentName ]], !Equals [ !Ref AccountName, Jumpstart ]]
  ConfigureGlobal: !Equals [ !Ref 'AWS::Region', us-east-1 ]
  ConfigureDirectoryIntegration: !Not [ !Equals [ !Ref DirectoryStackName, '' ]]
  ConfigureActiveDirectoryIntegration: !Equals [ !Select [ 1, !Split [ '-', !Ref DirectoryStackName ]], 'ActiveDirectory' ]
  ConfigureKey: !Not [ !Equals [ !Ref KeyName, '' ]]
  ConfigureStandby: !Equals [ !Ref EnvironmentType, standby ]
  ConfigureMultiZone: !Not [ !Equals [ !Ref EnvironmentZones, 1 ]]
  InstallAwsCliProduct: !Not [ !Equals [ !Ref AwsCliProductObject, '' ]]
  InstallChromeProduct: !Not [ !Equals [ !Ref ChromeProductObject, '' ]]
  InstallRoyalTSProduct: !Not [ !Equals [ !Ref RoyalTSProductObject, '' ]]
  InstallPuTTYProduct: !Not [ !Equals [ !Ref PuTTYProductObject, '' ]]
  ConfigureStaticPublicAddress: !Equals [ !Ref UseStaticPublicAddress, true ]
  ConfigureStaticPublicAddress&MultiZone: !And [ !Condition ConfigureStaticPublicAddress, !Condition ConfigureMultiZone ]
  ConfigureFedRAMP: !Equals [ !Ref UseFedRAMP, true ]
  ConfigureDomainName: !And [ !Not [ !Equals [ !Ref UtilityDomain, '' ]], !Condition ConfigureStaticPublicAddress ]
  ConfigureDomainName&MultiZone: !And [ !Condition ConfigureDomainName, !Condition ConfigureMultiZone ]
  ConfigureOnSchedule: !And [ !Not [ !Equals [ !Ref OnSchedule, '' ]], !Not [ !Condition ConfigureStandby ]]
  ConfigureOffSchedule: !And [ !Not [ !Equals [ !Ref OffSchedule , '' ]], !Not [ !Condition ConfigureStandby ]]
  ConfigureAdminPassword: !Not [ !Equals [ !Ref DirectoryAdministratorPassword, '' ]]
  ConfigureUserNetwork0: !Not [ !Equals [ !Select [ 0, !Split [ ',', !Ref UserNetworks ]], '-' ]]
  ConfigureUserNetwork1: !Not [ !Equals [ !Select [ 1, !Split [ ',', !Ref UserNetworks ]], '-' ]]
  ConfigureUserNetwork2: !Not [ !Equals [ !Select [ 2, !Split [ ',', !Ref UserNetworks ]], '-' ]]
  ConfigureUserNetwork3: !Not [ !Equals [ !Select [ 3, !Split [ ',', !Ref UserNetworks ]], '-' ]]
  ConfigureUserNetwork4: !Not [ !Equals [ !Select [ 4, !Split [ ',', !Ref UserNetworks ]], '-' ]]
  ConfigureUserNetwork5: !Not [ !Equals [ !Select [ 5, !Split [ ',', !Ref UserNetworks ]], '-' ]]
  ConfigureUserNetwork6: !Not [ !Equals [ !Select [ 6, !Split [ ',', !Ref UserNetworks ]], '-' ]]
  ConfigureUserNetwork7: !Not [ !Equals [ !Select [ 7, !Split [ ',', !Ref UserNetworks ]], '-' ]]
  ConfigureUserNetwork8: !Not [ !Equals [ !Select [ 8, !Split [ ',', !Ref UserNetworks ]], '-' ]]
  ConfigureUserNetwork9: !Not [ !Equals [ !Select [ 9, !Split [ ',', !Ref UserNetworks ]], '-' ]]
  ConfigureUserNetwork10: !Not [ !Equals [ !Select [ 10, !Split [ ',', !Ref UserNetworks ]], '-' ]]
  ConfigureUserNetwork11: !Not [ !Equals [ !Select [ 11, !Split [ ',', !Ref UserNetworks ]], '-' ]]
  ConfigureUserNetwork12: !Not [ !Equals [ !Select [ 12, !Split [ ',', !Ref UserNetworks ]], '-' ]]
  ConfigureUserNetwork13: !Not [ !Equals [ !Select [ 13, !Split [ ',', !Ref UserNetworks ]], '-' ]]
  ConfigureUserNetwork14: !Not [ !Equals [ !Select [ 14, !Split [ ',', !Ref UserNetworks ]], '-' ]]
  ConfigureUserNetwork15: !Not [ !Equals [ !Select [ 15, !Split [ ',', !Ref UserNetworks ]], '-' ]]
Resources:
  Role:
    Type: AWS::IAM::Role
    Properties:
      Path: /
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM
        - arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy
      Policies:
        - PolicyName: GetPasswordSecretPolicy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                Resource:
                  - !Sub arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${EnvironmentName}-DirectoryService-AdminPassword-*
                  - !Sub arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${EnvironmentName}-ActiveDirectory-AdminPassword-*
        - PolicyName: DownloadScriptFromS3Policy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                Resource:
                  - !Sub
                    - arn:aws:s3:::${ScriptsBucket}/Modules/*
                    - ScriptsBucket: !ImportValue
                        Fn::Sub: ${BucketsStackName}-ScriptsBucket
                  - !Sub
                    - arn:aws:s3:::${ScriptsBucket}/Windows/*
                    - ScriptsBucket: !ImportValue
                        Fn::Sub: ${BucketsStackName}-ScriptsBucket
                  - !Sub
                    - arn:aws:s3:::${ScriptsBucket}/WindowsBastions/*
                    - ScriptsBucket: !ImportValue
                        Fn::Sub: ${BucketsStackName}-ScriptsBucket
        - PolicyName: DownloadConfigurationFromS3Policy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                Resource:
                  - !Sub
                    - arn:aws:s3:::${ConfigurationsBucket}/Windows/*
                    - ConfigurationsBucket: !ImportValue
                        Fn::Sub: ${BucketsStackName}-ConfigurationsBucket
                  - !Sub
                    - arn:aws:s3:::${ConfigurationsBucket}/WindowsBastions/*
                    - ConfigurationsBucket: !ImportValue
                        Fn::Sub: ${BucketsStackName}-ConfigurationsBucket
        - PolicyName: DownloadProductFromS3Policy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                Resource:
                  - !Sub
                    - arn:aws:s3:::${ProductsBucket}/Windows/*
                    - ProductsBucket: !ImportValue
                        Fn::Sub: ${BucketsStackName}-ProductsBucket
                  - !Sub
                    - arn:aws:s3:::${ProductsBucket}/WindowsBastions/*
                    - ProductsBucket: !ImportValue
                        Fn::Sub: ${BucketsStackName}-ProductsBucket
        - PolicyName: StaticPublicAddressPolicy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - ec2:AssociateAddress
                  - ec2:DisassociateAddress
                Resource: '*'
  LogGroupName:
    Type: Custom::LogGroupName
    Properties:
      ServiceToken: !ImportValue
        Fn::Sub: ${CodesStackName}-LogGroupNameFunctionArn
      CompanyName: !Ref CompanyName
      SystemName: !Ref SystemName
      ApplicationName: !Ref UtilityName
      EnvironmentName: !If [ ConfigureAccountEnvironment, !Ref EnvironmentName , !Ref 'AWS::NoValue' ]
  LogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Ref LogGroupName
      RetentionInDays: !Ref LogRetention
  InstanceSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: !Sub ${EnvironmentName}-${UtilityName}-InstanceSecurityGroup
      VpcId: !ImportValue
        Fn::Sub: ${VPCStackName}-VPC
      SecurityGroupIngress:
        - IpProtocol: icmp
          FromPort: -1
          ToPort: -1
          CidrIp: !ImportValue
            Fn::Sub: ${VPCStackName}-VPCNetwork
          Description: VPC (ICMP)
        - !If
          - ConfigureUserNetwork0
          - IpProtocol: icmp
            FromPort: -1
            ToPort: -1
            CidrIp: !Select [ 0, !Split [ ',', !Ref UserNetworks ]]
            Description: !Sub
              - ${NetworkDescription} (ICMP)
              - NetworkDescription: !Select [ 0, !Split [ ',', !Ref UserNetworkDescriptions ]]
          - !Ref AWS::NoValue
        - !If
          - ConfigureUserNetwork0
          - IpProtocol: tcp
            FromPort: 443
            ToPort: 443
            CidrIp: !Select [ 0, !Split [ ',', !Ref UserNetworks ]]
            Description: !Sub
              - ${NetworkDescription} (HTTPS)
              - NetworkDescription: !Select [ 0, !Split [ ',', !Ref UserNetworkDescriptions ]]
          - !Ref AWS::NoValue
        - !If
          - ConfigureUserNetwork0
          - IpProtocol: tcp
            FromPort: 3389
            ToPort: 3389
            CidrIp: !Select [ 0, !Split [ ',', !Ref UserNetworks ]]
            Description: !Sub
              - ${NetworkDescription} (RDP)
              - NetworkDescription: !Select [ 0, !Split [ ',', !Ref UserNetworkDescriptions ]]
          - !Ref AWS::NoValue
        - !If
          - ConfigureUserNetwork1
          - IpProtocol: icmp
            FromPort: -1
            ToPort: -1
            CidrIp: !Select [ 1, !Split [ ',', !Ref UserNetworks ]]
            Description: !Sub
              - ${NetworkDescription} (ICMP)
              - NetworkDescription: !Select [ 1, !Split [ ',', !Ref UserNetworkDescriptions ]]
          - !Ref AWS::NoValue
        - !If
          - ConfigureUserNetwork1
          - IpProtocol: tcp
            FromPort: 443
            ToPort: 443
            CidrIp: !Select [ 1, !Split [ ',', !Ref UserNetworks ]]
            Description: !Sub
              - ${NetworkDescription} (HTTPS)
              - NetworkDescription: !Select [ 1, !Split [ ',', !Ref UserNetworkDescriptions ]]
          - !Ref AWS::NoValue
        - !If
          - ConfigureUserNetwork1
          - IpProtocol: tcp
            FromPort: 3389
            ToPort: 3389
            CidrIp: !Select [ 1, !Split [ ',', !Ref UserNetworks ]]
            Description: !Sub
              - ${NetworkDescription} (RDP)
              - NetworkDescription: !Select [ 1, !Split [ ',', !Ref UserNetworkDescriptions ]]
          - !Ref AWS::NoValue
        - !If
          - ConfigureUserNetwork2
          - IpProtocol: icmp
            FromPort: -1
            ToPort: -1
            CidrIp: !Select [ 2, !Split [ ',', !Ref UserNetworks ]]
            Description: !Sub
              - ${NetworkDescription} (ICMP)
              - NetworkDescription: !Select [ 2, !Split [ ',', !Ref UserNetworkDescriptions ]]
          - !Ref AWS::NoValue
        - !If
          - ConfigureUserNetwork2
          - IpProtocol: tcp
            FromPort: 443
            ToPort: 443
            CidrIp: !Select [ 2, !Split [ ',', !Ref UserNetworks ]]
            Description: !Sub
              - ${NetworkDescription} (HTTPS)
              - NetworkDescription: !Select [ 2, !Split [ ',', !Ref UserNetworkDescriptions ]]
          - !Ref AWS::NoValue
        - !If
          - ConfigureUserNetwork2
          - IpProtocol: tcp
            FromPort: 3389
            ToPort: 3389
            CidrIp: !Select [ 2, !Split [ ',', !Ref UserNetworks ]]
            Description: !Sub
              - ${NetworkDescription} (RDP)
              - NetworkDescription: !Select [ 2, !Split [ ',', !Ref UserNetworkDescriptions ]]
          - !Ref AWS::NoValue
        - !If
          - ConfigureUserNetwork3
          - IpProtocol: icmp
            FromPort: -1
            ToPort: -1
            CidrIp: !Select [ 3, !Split [ ',', !Ref UserNetworks ]]
            Description: !Sub
              - ${NetworkDescription} (ICMP)
              - NetworkDescription: !Select [ 3, !Split [ ',', !Ref UserNetworkDescriptions ]]
          - !Ref AWS::NoValue
        - !If
          - ConfigureUserNetwork3
          - IpProtocol: tcp
            FromPort: 443
            ToPort: 443
            CidrIp: !Select [ 3, !Split [ ',', !Ref UserNetworks ]]
            Description: !Sub
              - ${NetworkDescription} (HTTPS)
              - NetworkDescription: !Select [ 3, !Split [ ',', !Ref UserNetworkDescriptions ]]
          - !Ref AWS::NoValue
        - !If
          - ConfigureUserNetwork3
          - IpProtocol: tcp
            FromPort: 3389
            ToPort: 3389
            CidrIp: !Select [ 3, !Split [ ',', !Ref UserNetworks ]]
            Description: !Sub
              - ${NetworkDescription} (RDP)
              - NetworkDescription: !Select [ 3, !Split [ ',', !Ref UserNetworkDescriptions ]]
          - !Ref AWS::NoValue
        - !If
          - ConfigureUserNetwork4
          - IpProtocol: icmp
            FromPort: -1
            ToPort: -1
            CidrIp: !Select [ 4, !Split [ ',', !Ref UserNetworks ]]
            Description: !Sub
              - ${NetworkDescription} (ICMP)
              - NetworkDescription: !Select [ 4, !Split [ ',', !Ref UserNetworkDescriptions ]]
          - !Ref AWS::NoValue
        - !If
          - ConfigureUserNetwork4
          - IpProtocol: tcp
            FromPort: 443
            ToPort: 443
            CidrIp: !Select [ 4, !Split [ ',', !Ref UserNetworks ]]
            Description: !Sub
              - ${NetworkDescription} (HTTPS)
              - NetworkDescription: !Select [ 4, !Split [ ',', !Ref UserNetworkDescriptions ]]
          - !Ref AWS::NoValue
        - !If
          - ConfigureUserNetwork4
          - IpProtocol: tcp
            FromPort: 3389
            ToPort: 3389
            CidrIp: !Select [ 4, !Split [ ',', !Ref UserNetworks ]]
            Description: !Sub
              - ${NetworkDescription} (RDP)
              - NetworkDescription: !Select [ 4, !Split [ ',', !Ref UserNetworkDescriptions ]]
          - !Ref AWS::NoValue
        - !If
          - ConfigureUserNetwork5
          - IpProtocol: icmp
            FromPort: -1
            ToPort: -1
            CidrIp: !Select [ 5, !Split [ ',', !Ref UserNetworks ]]
            Description: !Sub
              - ${NetworkDescription} (ICMP)
              - NetworkDescription: !Select [ 5, !Split [ ',', !Ref UserNetworkDescriptions ]]
          - !Ref AWS::NoValue
        - !If
          - ConfigureUserNetwork5
          - IpProtocol: tcp
            FromPort: 443
            ToPort: 443
            CidrIp: !Select [ 5, !Split [ ',', !Ref UserNetworks ]]
            Description: !Sub
              - ${NetworkDescription} (HTTPS)
              - NetworkDescription: !Select [ 5, !Split [ ',', !Ref UserNetworkDescriptions ]]
          - !Ref AWS::NoValue
        - !If
          - ConfigureUserNetwork5
          - IpProtocol: tcp
            FromPort: 3389
            ToPort: 3389
            CidrIp: !Select [ 5, !Split [ ',', !Ref UserNetworks ]]
            Description: !Sub
              - ${NetworkDescription} (RDP)
              - NetworkDescription: !Select [ 5, !Split [ ',', !Ref UserNetworkDescriptions ]]
          - !Ref AWS::NoValue
        - !If
          - ConfigureUserNetwork6
          - IpProtocol: icmp
            FromPort: -1
            ToPort: -1
            CidrIp: !Select [ 6, !Split [ ',', !Ref UserNetworks ]]
            Description: !Sub
              - ${NetworkDescription} (ICMP)
              - NetworkDescription: !Select [ 6, !Split [ ',', !Ref UserNetworkDescriptions ]]
          - !Ref AWS::NoValue
        - !If
          - ConfigureUserNetwork6
          - IpProtocol: tcp
            FromPort: 443
            ToPort: 443
            CidrIp: !Select [ 6, !Split [ ',', !Ref UserNetworks ]]
            Description: !Sub
              - ${NetworkDescription} (HTTPS)
              - NetworkDescription: !Select [ 6, !Split [ ',', !Ref UserNetworkDescriptions ]]
          - !Ref AWS::NoValue
        - !If
          - ConfigureUserNetwork6
          - IpProtocol: tcp
            FromPort: 3389
            ToPort: 3389
            CidrIp: !Select [ 6, !Split [ ',', !Ref UserNetworks ]]
            Description: !Sub
              - ${NetworkDescription} (RDP)
              - NetworkDescription: !Select [ 6, !Split [ ',', !Ref UserNetworkDescriptions ]]
          - !Ref AWS::NoValue
        - !If
          - ConfigureUserNetwork7
          - IpProtocol: icmp
            FromPort: -1
            ToPort: -1
            CidrIp: !Select [ 7, !Split [ ',', !Ref UserNetworks ]]
            Description: !Sub
              - ${NetworkDescription} (ICMP)
              - NetworkDescription: !Select [ 7, !Split [ ',', !Ref UserNetworkDescriptions ]]
          - !Ref AWS::NoValue
        - !If
          - ConfigureUserNetwork7
          - IpProtocol: tcp
            FromPort: 443
            ToPort: 443
            CidrIp: !Select [ 7, !Split [ ',', !Ref UserNetworks ]]
            Description: !Sub
              - ${NetworkDescription} (HTTPS)
              - NetworkDescription: !Select [ 7, !Split [ ',', !Ref UserNetworkDescriptions ]]
          - !Ref AWS::NoValue
        - !If
          - ConfigureUserNetwork7
          - IpProtocol: tcp
            FromPort: 3389
            ToPort: 3389
            CidrIp: !Select [ 7, !Split [ ',', !Ref UserNetworks ]]
            Description: !Sub
              - ${NetworkDescription} (RDP)
              - NetworkDescription: !Select [ 7, !Split [ ',', !Ref UserNetworkDescriptions ]]
          - !Ref AWS::NoValue
        - !If
          - ConfigureUserNetwork8
          - IpProtocol: icmp
            FromPort: -1
            ToPort: -1
            CidrIp: !Select [ 8, !Split [ ',', !Ref UserNetworks ]]
            Description: !Sub
              - ${NetworkDescription} (ICMP)
              - NetworkDescription: !Select [ 8, !Split [ ',', !Ref UserNetworkDescriptions ]]
          - !Ref AWS::NoValue
        - !If
          - ConfigureUserNetwork8
          - IpProtocol: tcp
            FromPort: 443
            ToPort: 443
            CidrIp: !Select [ 8, !Split [ ',', !Ref UserNetworks ]]
            Description: !Sub
              - ${NetworkDescription} (HTTPS)
              - NetworkDescription: !Select [ 8, !Split [ ',', !Ref UserNetworkDescriptions ]]
          - !Ref AWS::NoValue
        - !If
          - ConfigureUserNetwork8
          - IpProtocol: tcp
            FromPort: 3389
            ToPort: 3389
            CidrIp: !Select [ 8, !Split [ ',', !Ref UserNetworks ]]
            Description: !Sub
              - ${NetworkDescription} (RDP)
              - NetworkDescription: !Select [ 8, !Split [ ',', !Ref UserNetworkDescriptions ]]
          - !Ref AWS::NoValue
        - !If
          - ConfigureUserNetwork9
          - IpProtocol: icmp
            FromPort: -1
            ToPort: -1
            CidrIp: !Select [ 9, !Split [ ',', !Ref UserNetworks ]]
            Description: !Sub
              - ${NetworkDescription} (ICMP)
              - NetworkDescription: !Select [ 9, !Split [ ',', !Ref UserNetworkDescriptions ]]
          - !Ref AWS::NoValue
        - !If
          - ConfigureUserNetwork9
          - IpProtocol: tcp
            FromPort: 443
            ToPort: 443
            CidrIp: !Select [ 9, !Split [ ',', !Ref UserNetworks ]]
            Description: !Sub
              - ${NetworkDescription} (HTTPS)
              - NetworkDescription: !Select [ 9, !Split [ ',', !Ref UserNetworkDescriptions ]]
          - !Ref AWS::NoValue
        - !If
          - ConfigureUserNetwork9
          - IpProtocol: tcp
            FromPort: 3389
            ToPort: 3389
            CidrIp: !Select [ 9, !Split [ ',', !Ref UserNetworks ]]
            Description: !Sub
              - ${NetworkDescription} (RDP)
              - NetworkDescription: !Select [ 9, !Split [ ',', !Ref UserNetworkDescriptions ]]
          - !Ref AWS::NoValue
        - !If
          - ConfigureUserNetwork10
          - IpProtocol: icmp
            FromPort: -1
            ToPort: -1
            CidrIp: !Select [ 10, !Split [ ',', !Ref UserNetworks ]]
            Description: !Sub
              - ${NetworkDescription} (ICMP)
              - NetworkDescription: !Select [ 10, !Split [ ',', !Ref UserNetworkDescriptions ]]
          - !Ref AWS::NoValue
        - !If
          - ConfigureUserNetwork10
          - IpProtocol: tcp
            FromPort: 443
            ToPort: 443
            CidrIp: !Select [ 10, !Split [ ',', !Ref UserNetworks ]]
            Description: !Sub
              - ${NetworkDescription} (HTTPS)
              - NetworkDescription: !Select [ 10, !Split [ ',', !Ref UserNetworkDescriptions ]]
          - !Ref AWS::NoValue
        - !If
          - ConfigureUserNetwork10
          - IpProtocol: tcp
            FromPort: 3389
            ToPort: 3389
            CidrIp: !Select [ 10, !Split [ ',', !Ref UserNetworks ]]
            Description: !Sub
              - ${NetworkDescription} (RDP)
              - NetworkDescription: !Select [ 10, !Split [ ',', !Ref UserNetworkDescriptions ]]
          - !Ref AWS::NoValue
        - !If
          - ConfigureUserNetwork11
          - IpProtocol: icmp
            FromPort: -1
            ToPort: -1
            CidrIp: !Select [ 11, !Split [ ',', !Ref UserNetworks ]]
            Description: !Sub
              - ${NetworkDescription} (ICMP)
              - NetworkDescription: !Select [ 11, !Split [ ',', !Ref UserNetworkDescriptions ]]
          - !Ref AWS::NoValue
        - !If
          - ConfigureUserNetwork11
          - IpProtocol: tcp
            FromPort: 443
            ToPort: 443
            CidrIp: !Select [ 11, !Split [ ',', !Ref UserNetworks ]]
            Description: !Sub
              - ${NetworkDescription} (HTTPS)
              - NetworkDescription: !Select [ 11, !Split [ ',', !Ref UserNetworkDescriptions ]]
          - !Ref AWS::NoValue
        - !If
          - ConfigureUserNetwork11
          - IpProtocol: tcp
            FromPort: 3389
            ToPort: 3389
            CidrIp: !Select [ 11, !Split [ ',', !Ref UserNetworks ]]
            Description: !Sub
              - ${NetworkDescription} (RDP)
              - NetworkDescription: !Select [ 11, !Split [ ',', !Ref UserNetworkDescriptions ]]
          - !Ref AWS::NoValue
        - !If
          - ConfigureUserNetwork12
          - IpProtocol: icmp
            FromPort: -1
            ToPort: -1
            CidrIp: !Select [ 12, !Split [ ',', !Ref UserNetworks ]]
            Description: !Sub
              - ${NetworkDescription} (ICMP)
              - NetworkDescription: !Select [ 12, !Split [ ',', !Ref UserNetworkDescriptions ]]
          - !Ref AWS::NoValue
        - !If
          - ConfigureUserNetwork12
          - IpProtocol: tcp
            FromPort: 443
            ToPort: 443
            CidrIp: !Select [ 12, !Split [ ',', !Ref UserNetworks ]]
            Description: !Sub
              - ${NetworkDescription} (HTTPS)
              - NetworkDescription: !Select [ 12, !Split [ ',', !Ref UserNetworkDescriptions ]]
          - !Ref AWS::NoValue
        - !If
          - ConfigureUserNetwork12
          - IpProtocol: tcp
            FromPort: 3389
            ToPort: 3389
            CidrIp: !Select [ 12, !Split [ ',', !Ref UserNetworks ]]
            Description: !Sub
              - ${NetworkDescription} (RDP)
              - NetworkDescription: !Select [ 12, !Split [ ',', !Ref UserNetworkDescriptions ]]
          - !Ref AWS::NoValue
        - !If
          - ConfigureUserNetwork13
          - IpProtocol: icmp
            FromPort: -1
            ToPort: -1
            CidrIp: !Select [ 13, !Split [ ',', !Ref UserNetworks ]]
            Description: !Sub
              - ${NetworkDescription} (ICMP)
              - NetworkDescription: !Select [ 13, !Split [ ',', !Ref UserNetworkDescriptions ]]
          - !Ref AWS::NoValue
        - !If
          - ConfigureUserNetwork13
          - IpProtocol: tcp
            FromPort: 443
            ToPort: 443
            CidrIp: !Select [ 13, !Split [ ',', !Ref UserNetworks ]]
            Description: !Sub
              - ${NetworkDescription} (HTTPS)
              - NetworkDescription: !Select [ 13, !Split [ ',', !Ref UserNetworkDescriptions ]]
          - !Ref AWS::NoValue
        - !If
          - ConfigureUserNetwork13
          - IpProtocol: tcp
            FromPort: 3389
            ToPort: 3389
            CidrIp: !Select [ 13, !Split [ ',', !Ref UserNetworks ]]
            Description: !Sub
              - ${NetworkDescription} (RDP)
              - NetworkDescription: !Select [ 13, !Split [ ',', !Ref UserNetworkDescriptions ]]
          - !Ref AWS::NoValue
        - !If
          - ConfigureUserNetwork14
          - IpProtocol: icmp
            FromPort: -1
            ToPort: -1
            CidrIp: !Select [ 14, !Split [ ',', !Ref UserNetworks ]]
            Description: !Sub
              - ${NetworkDescription} (ICMP)
              - NetworkDescription: !Select [ 14, !Split [ ',', !Ref UserNetworkDescriptions ]]
          - !Ref AWS::NoValue
        - !If
          - ConfigureUserNetwork14
          - IpProtocol: tcp
            FromPort: 443
            ToPort: 443
            CidrIp: !Select [ 14, !Split [ ',', !Ref UserNetworks ]]
            Description: !Sub
              - ${NetworkDescription} (HTTPS)
              - NetworkDescription: !Select [ 14, !Split [ ',', !Ref UserNetworkDescriptions ]]
          - !Ref AWS::NoValue
        - !If
          - ConfigureUserNetwork14
          - IpProtocol: tcp
            FromPort: 3389
            ToPort: 3389
            CidrIp: !Select [ 14, !Split [ ',', !Ref UserNetworks ]]
            Description: !Sub
              - ${NetworkDescription} (RDP)
              - NetworkDescription: !Select [ 14, !Split [ ',', !Ref UserNetworkDescriptions ]]
          - !Ref AWS::NoValue
        - !If
          - ConfigureUserNetwork15
          - IpProtocol: icmp
            FromPort: -1
            ToPort: -1
            CidrIp: !Select [ 15, !Split [ ',', !Ref UserNetworks ]]
            Description: !Sub
              - ${NetworkDescription} (ICMP)
              - NetworkDescription: !Select [ 15, !Split [ ',', !Ref UserNetworkDescriptions ]]
          - !Ref AWS::NoValue
        - !If
          - ConfigureUserNetwork15
          - IpProtocol: tcp
            FromPort: 443
            ToPort: 443
            CidrIp: !Select [ 15, !Split [ ',', !Ref UserNetworks ]]
            Description: !Sub
              - ${NetworkDescription} (HTTPS)
              - NetworkDescription: !Select [ 15, !Split [ ',', !Ref UserNetworkDescriptions ]]
          - !Ref AWS::NoValue
        - !If
          - ConfigureUserNetwork15
          - IpProtocol: tcp
            FromPort: 3389
            ToPort: 3389
            CidrIp: !Select [ 15, !Split [ ',', !Ref UserNetworks ]]
            Description: !Sub
              - ${NetworkDescription} (RDP)
              - NetworkDescription: !Select [ 15, !Split [ ',', !Ref UserNetworkDescriptions ]]
          - !Ref AWS::NoValue
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-${UtilityName}-InstanceSecurityGroup
  EIPA:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
    Condition: ConfigureStaticPublicAddress
  EIPB:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
    Condition: ConfigureStaticPublicAddress&MultiZone
  HostName:
    Type: Custom::HostName
    Properties:
      ServiceToken: !ImportValue
        Fn::Sub: ${CodesStackName}-HostNameFunctionArn
      CompanyName: !Ref CompanyName
      LocationName: !Ref AWS::Region
      EnvironmentName: !Ref EnvironmentName
      ApplicationName: !Ref UtilityName
      InstanceNumber: 01
      # Note: ZoneCode cannot be used here, as it will not be known. AutoScaling may create Instances in more than one
      #       AvailabilityZone. So, we have to use a script run during initial boot that appends the Zone Code to the
      #       HostName without Zone Code created here.
  WindowsImage:
    Type: Custom::WindowsImage
    Properties:
      ServiceToken: !ImportValue
        Fn::Sub: ${AMIFunctionsStackName}-WindowsImageFunctionArn
      Region: !Ref AWS::Region
      OSName: !Ref OSName
  InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: /
      Roles:
        - !Ref Role
  LaunchConfiguration:
    Type: AWS::AutoScaling::LaunchConfiguration
    Metadata:
      AWS::CloudFormation::Authentication:
        S3Credentials:
          type: S3
          roleName: !Ref Role
          buckets:
            - !ImportValue
              Fn::Sub: ${BucketsStackName}-ScriptsBucket
            - !ImportValue
              Fn::Sub: ${BucketsStackName}-ConfigurationsBucket
            - !ImportValue
              Fn::Sub: ${BucketsStackName}-ProductsBucket
      AWS::CloudFormation::Init:
        configSets:
          All:
            - InstallCloudFormationModule
            - RegisterCloudFormationSignal
            - ConfigureOS
            - ConfigureCFN
            - InstallSSMAgent
            - InstallCloudWatchAgent
            - ConfigureCloudWatchAgent
            - ConfigureHostName
            - JoinDomain
            - InstallRDSGateway
            - ConfigureRDSGateway
            - ConfigureRemoteDesktopUsers
            - !If [ ConfigureStaticPublicAddress, ConfigureStaticPublicAddress, !Ref 'AWS::NoValue' ]
            - !If [ InstallAwsCliProduct, InstallAwsCliProduct, !Ref 'AWS::NoValue' ]
            - !If [ InstallChromeProduct, InstallChromeProduct, !Ref 'AWS::NoValue' ]
            - !If [ InstallRoyalTSProduct, InstallRoyalTSProduct, !Ref 'AWS::NoValue' ]
            - !If [ InstallPuTTYProduct, InstallPuTTYProduct, !Ref 'AWS::NoValue' ]
            - SignalCloudFormation
        InstallCloudFormationModule:
          files:
            C:\Windows\system32\WindowsPowerShell\v1.0\Modules\CloudFormation\CloudFormation.psm1:
              source: !Sub
                - https://${ScriptsBucket}.${s3}.amazonaws.com/Modules/CloudFormation.psm1
                - ScriptsBucket: !ImportValue
                    Fn::Sub: ${BucketsStackName}-ScriptsBucket
                  s3: !If [ ConfigureGlobal, s3, !Sub 's3-${AWS::Region}' ]
              authentication: S3Credentials
        RegisterCloudFormationSignal:
          commands:
            01-register-signal:
              command: !Sub 'powershell.exe -Command "Register-CloudFormationSignal
                -Stack ''${AWS::StackName}''
                -Resource ''AutoScalingGroup''
                -Region ''${AWS::Region}''"'
              waitAfterCompletion: 0
        ConfigureOS:
          commands:
            01-set-execution-policy:
              command: powershell.exe -Command "Set-ExecutionPolicy RemoteSigned -Force"
              waitAfterCompletion: 0
        ConfigureCFN:
          files:
            C:\cfn\cfn-hup.conf:
              content: !Sub |
                [main]
                stack=${AWS::StackId}
                region=${AWS::Region}
            C:\cfn\hooks.d\cfn-auto-reloader.conf:
              content: !Sub |
                [cfn-auto-reloader-hook]
                triggers=post.update
                path=Resources.LaunchConfiguration.Metadata.AWS::CloudFormation::Init
                action=cfn-init.exe --verbose --configsets All --stack ${AWS::StackId} --resource LaunchConfiguration --region ${AWS::Region}
          services:
            windows:
              cfn-hup:
                enabled: true
                ensureRunning: true
                files:
                  - C:\cfn\cfn-hup.conf
                  - C:\cfn\hooks.d\cfn-auto-reloader.conf
        InstallSSMAgent:
          files:
            C:\cfn\temp\AmazonSSMAgentSetup.exe:
              source: https://s3.amazonaws.com/ec2-downloads-windows/SSMAgent/latest/windows_amd64/AmazonSSMAgentSetup.exe
          commands:
            01-install-ssm-agent:
              command: C:\cfn\temp\AmazonSSMAgentSetup.exe /install /passive /quiet
              ignoreErrors: false
        InstallCloudWatchAgent:
          sources:
            C:\cfn\temp\AmazonCloudWatchAgent: https://s3.amazonaws.com/amazoncloudwatch-agent/windows/amd64/latest/AmazonCloudWatchAgent.zip
          commands:
            01-install-cloudwatch-agent:
              command: powershell.exe -Command ".\install.ps1"
              cwd: C:\cfn\temp\AmazonCloudWatchAgent
              ignoreErrors: false
        ConfigureCloudWatchAgent:
          files:
            C:\ProgramData\Amazon\AmazonCloudWatchAgent\amazon-cloudwatch-agent.json:
              content: !Sub |
                {
                  "agent" : {
                    "metrics_collection_interval" : 60,
                    "logfile" : "C:\\Program Files\\Amazon\\CloudWatchAgent\\Logs\\amazon-cloudwatch-agent.log",
                    "debug" : false
                  },
                  "metrics" : {
                    "namespace" : "${SystemName}/${EnvironmentName}-${UtilityName}",
                    "metrics_collected" : {
                      "Memory" : {
                        "measurement" : [
                          { "name" : "% Committed Bytes In Use", "rename" : "MemoryCommittedPercent", "unit" : "Percent" },
                          { "name" : "Pages/sec", "rename" : "MemoryPageOps", "unit" : "Count/Second" }
                        ]
                      },
                      "LogicalDisk" : {
                        "resources" : [
                          "C:",
                          "D:"
                        ],
                        "measurement" : [
                          { "name" : "% Free Space", "rename" : "DiskFreePercent", "unit" : "Percent" },
                          { "name" : "Free Megabytes", "rename" : "DiskFreeMegabytes", "unit" : "Megabytes" },
                          { "name" : "Disk Bytes/sec", "rename" : "DiskBytesPerSecond", "unit" : "Bytes/Second" },
                          { "name" : "Avg. Disk Queue Length", "rename" : "DiskQueueLength", "unit" : "Count" }
                        ]
                      }
                    },
                    "append_dimensions" : {
                      "InstanceId" : "${!aws:InstanceId}",
                      "AutoScalingGroupName" : "${!aws:AutoScalingGroupName}"
                    },
                    "aggregation_dimensions" : [
                      [ "InstanceId" ],
                      [ "AutoScalingGroupName" ],
                      []
                    ]
                  },
                  "logs" : {
                    "logs_collected" : {
                      "windows_events" : {
                        "collect_list" : [
                          {
                            "event_name" : "Application",
                            "event_levels" : [ "ERROR", "WARNING", "INFORMATION" ],
                            "log_group_name" : "${LogGroup}",
                            "log_stream_name" : "Bastion/{instance_id}/ApplicationEventLog",
                            "event_format" : "text"
                          },
                          {
                            "event_name" : "System",
                            "event_levels" : [ "ERROR", "WARNING", "INFORMATION" ],
                            "log_group_name" : "${LogGroup}",
                            "log_stream_name" : "Bastion/{instance_id}/SystemEventLog",
                            "event_format" : "text"
                          },
                          {
                            "event_name" : "Security",
                            "event_levels" : [ "ERROR", "WARNING", "INFORMATION" ],
                            "log_group_name" : "${LogGroup}",
                            "log_stream_name" : "Bastion/{instance_id}/SecurityEventLog",
                            "event_format" : "text"
                          }
                        ]
                      },
                      "files" : {
                        "collect_list" : [
                          {
                            "file_path" : "C:\\Program Files\\Amazon\\CloudWatchAgent\\Logs\\amazon-cloudwatch-agent.log",
                            "log_group_name" : "${LogGroup}",
                            "log_stream_name" : "Bastion/{instance_id}/amazon-cloudwatch-agent.log",
                            "timezone" : "UTC"
                          },
                          {
                            "file_path" : "C:\\Program Files\\Amazon\\Ec2ConfigService\\Logs\\EC2ConfigLog.txt",
                            "log_group_name" : "${LogGroup}",
                            "log_stream_name" : "Bastion/{instance_id}/EC2ConfigLog.txt",
                            "timezone" : "UTC"
                          },
                          {
                            "file_path" : "C:\\cfn\\log\\cfn-init.log",
                            "log_group_name" : "${LogGroup}",
                            "log_stream_name" : "Bastion/{instance_id}/cfn-init.log",
                            "timestamp_format" : "%Y-%m-%d %H:%M:%S",
                            "timezone" : "Local"
                          },
                          {
                            "file_path" : "C:\\cfn\\log\\cfn-init-cmd.log",
                            "log_group_name" : "${LogGroup}",
                            "log_stream_name" : "Bastion/{instance_id}/cfn-init-cmd.log",
                            "timestamp_format" : "%Y-%m-%d %H:%M:%S",
                            "timezone" : "Local"
                          },
                          {
                            "file_path" : "C:\\cfn\\log\\cfn-hup.log",
                            "log_group_name" : "${LogGroup}",
                            "log_stream_name" : "Bastion/{instance_id}/cfn-hup.log",
                            "timestamp_format" : "%Y-%m-%d %H:%M:%S",
                            "timezone" : "Local"
                          },
                          {
                            "file_path" : "C:\\inetpub\\logs\\LogFiles\\W3SVC1\\*.log",
                            "log_group_name" : "${LogGroup}",
                            "log_stream_name" : "Bastion/{instance_id}/IISLogs",
                            "timezone" : "UTC"
                          }
                        ]
                      }
                    }
                  }
                }
          commands:
            01-start-cloudwatch-agent:
              command: powershell.exe -Command ".\amazon-cloudwatch-agent-ctl.ps1 -a fetch-config -m ec2 -c file:C:\ProgramData\Amazon\AmazonCloudWatchAgent\amazon-cloudwatch-agent.json -s"
              cwd: C:\Program Files\Amazon\AmazonCloudWatchAgent
              ignoreErrors: false
          services:
            windows:
              AmazonCloudWatchAgent:
                enabled: true
                ensureRunning: true
                files:
                  - C:\ProgramData\Amazon\AmazonCloudWatchAgent\amazon-cloudwatch-agent.json
        ConfigureHostName:
          files:
            C:\cfn\scripts\Configure-HostName.ps1:
              source: !Sub
                - https://${ScriptsBucket}.${s3}.amazonaws.com/Windows/Configure-HostName.ps1
                - ScriptsBucket: !ImportValue
                    Fn::Sub: ${BucketsStackName}-ScriptsBucket
                  s3: !If [ ConfigureGlobal, s3, !Sub 's3-${AWS::Region}' ]
              authentication: S3Credentials
          commands:
            01-configure-hostname:
              command: !Sub powershell.exe -Command "C:\cfn\scripts\Configure-HostName.ps1
                -HostName ${HostName}
                -AppendZone"
              ignoreErrors: false
              waitAfterCompletion: forever
        JoinDomain:
          files:
            C:\cfn\scripts\Join-Domain.ps1:
              source: !Sub
                - https://${ScriptsBucket}.${s3}.amazonaws.com/Windows/Join-Domain.ps1
                - ScriptsBucket: !ImportValue
                    Fn::Sub: ${BucketsStackName}-ScriptsBucket
                  s3: !If [ ConfigureGlobal, s3, !Sub 's3-${AWS::Region}' ]
              authentication: S3Credentials
          commands:
            01-join-domain:
              command: !Sub
                - powershell.exe -Command "C:\cfn\scripts\Join-Domain.ps1
                  -DomainName ${VPCDirectoryDomain}
                  -PasswordSecretId ${PasswordSecretId}
                  -Password '${DirectoryAdministratorPassword}'"
                - VPCDirectoryDomain: !ImportValue
                    Fn::Sub: ${VPCStackName}-VPCDirectoryDomain
                  PasswordSecretId: !If
                    - ConfigureActiveDirectoryIntegration
                    - !Sub ${EnvironmentName}-ActiveDirectory-AdminPassword
                    - !Sub ${EnvironmentName}-DirectoryService-AdminPassword
              ignoreErrors: false
              waitAfterCompletion: forever
        InstallRDSGateway:
          commands:
            01-install-rds-gateway:
              command: powershell.exe -Command "Install-WindowsFeature RDS-Gateway,RSAT-RDS-Gateway"
              ignoreErrors: false
              waitAfterCompletion: 0
        ConfigureRDSGateway:
          files:
            C:\cfn\scripts\Initialize-RDGW.ps1:
              source: !Sub
                - https://${ScriptsBucket}.${s3}.amazonaws.com/WindowsBastions/Initialize-RDGW.ps1
                - ScriptsBucket: !ImportValue
                    Fn::Sub: ${BucketsStackName}-ScriptsBucket
                  s3: !If [ ConfigureGlobal, s3, !Sub 's3-${AWS::Region}' ]
              authentication: S3Credentials
          commands:
            01-initialize-rdgw:
              command: !Sub
                - powershell.exe -Command "C:\cfn\scripts\Initialize-RDGW.ps1
                  -ServerFQDN $($env:COMPUTERNAME + '.${VPCDirectoryDomain}')
                  -DomainNetBiosName ${VPCDirectoryNetBIOSDomain}
                  -GroupName 'Domain Admins'
                - VPCDirectoryDomain: !ImportValue
                    Fn::Sub: ${VPCStackName}-VPCDirectoryDomain
                  VPCDirectoryNetBIOSDomain: !ImportValue
                    Fn::Sub: ${VPCStackName}-VPCDirectoryNetBIOSDomain
              ignoreErrors: false
              waitAfterCompletion: 0
        ConfigureRemoteDesktopUsers:
          files:
            C:\cfn\scripts\Configure-RemoteDesktopUsers.ps1:
              source: !Sub
                - https://${ScriptsBucket}.${s3}.amazonaws.com/Windows/Configure-RemoteDesktopUsers.ps1
                - ScriptsBucket: !ImportValue
                    Fn::Sub: ${BucketsStackName}-ScriptsBucket
                  s3: !If [ ConfigureGlobal, s3, !Sub 's3-${AWS::Region}' ]
              authentication: S3Credentials
            C:\cfn\conf\RemoteDesktopUsers.csv:
              source: !Sub
                - https://${ConfigurationsBucket}.${s3}.amazonaws.com/WindowsBastions/RemoteDesktopUsers.csv
                - ConfigurationsBucket: !ImportValue
                    Fn::Sub: ${BucketsStackName}-ConfigurationsBucket
                  s3: !If [ ConfigureGlobal, s3, !Sub 's3-${AWS::Region}' ]
              authentication: S3Credentials
            C:\cfn\conf\CustomRemoteDesktopUsers.csv:
              source: !Sub
                - https://${ConfigurationsBucket}.${s3}.amazonaws.com/WindowsBastions/CustomRemoteDesktopUsers.csv
                - ConfigurationsBucket: !ImportValue
                    Fn::Sub: ${BucketsStackName}-ConfigurationsBucket
                  s3: !If [ ConfigureGlobal, s3, !Sub 's3-${AWS::Region}' ]
              authentication: S3Credentials
          commands:
            01-configure-remotedesktopusers:
              command: !Sub powershell.exe -Command "C:\cfn\scripts\Configure-RemoteDesktopUsers.ps1
                -RemoteDesktopUsers C:\cfn\conf\RemoteDesktopUsers.csv"
              ignoreErrors: false
              waitAfterCompletion: 0
            02-configure-custom-remotedesktopusers:
              command: !Sub powershell.exe -Command "C:\cfn\scripts\Configure-RemoteDesktopUsers.ps1
                -RemoteDesktopUsers C:\cfn\conf\CustomRemoteDesktopUsers.csv"
              ignoreErrors: false
              waitAfterCompletion: 0
        ConfigureStaticPublicAddress:
          files:
            C:\cfn\scripts\Associate-EIP.ps1:
              source: !Sub
                - https://${ScriptsBucket}.${s3}.amazonaws.com/Windows/Associate-EIP.ps1
                - ScriptsBucket: !ImportValue
                    Fn::Sub: ${BucketsStackName}-ScriptsBucket
                  s3: !If [ ConfigureGlobal, s3, !Sub 's3-${AWS::Region}' ]
              authentication: S3Credentials
          commands:
            01-associate-eip:
              command: !Sub
                - powershell.exe -Command "C:\cfn\scripts\Associate-EIP.ps1
                  -EIPAAllocationId ${EIPAAllocationId}
                  -EIPBAllocationId ${EIPBAllocationId}"
                - EIPAAllocationId: !If [ ConfigureStaticPublicAddress, !GetAtt EIPA.AllocationId, NONE ]
                  EIPBAllocationId: !If [ ConfigureStaticPublicAddress&MultiZone, !GetAtt EIPB.AllocationId, NONE ]
              ignoreErrors: false
              waitAfterCompletion: 15
        InstallAwsCliProduct:
          packages:
            msi:
              AwsCli: !Sub
                - https://${ProductsBucket}.${s3}.amazonaws.com/Windows/${AwsCliProductObject}
                - ProductsBucket: !ImportValue
                    Fn::Sub: ${BucketsStackName}-ProductsBucket
                  s3: !If [ ConfigureGlobal, s3, !Sub 's3-${AWS::Region}' ]
        InstallChromeProduct:
          packages:
            msi:
              Chrome: !Sub
                - https://${ProductsBucket}.${s3}.amazonaws.com/Windows/${ChromeProductObject}
                - ProductsBucket: !ImportValue
                    Fn::Sub: ${BucketsStackName}-ProductsBucket
                  s3: !If [ ConfigureGlobal, s3, !Sub 's3-${AWS::Region}' ]
        InstallRoyalTSProduct:
          packages:
            msi:
              RoyalTS: !Sub
                - https://${ProductsBucket}.${s3}.amazonaws.com/Windows/${RoyalTSProductObject}
                - ProductsBucket: !ImportValue
                    Fn::Sub: ${BucketsStackName}-ProductsBucket
                  s3: !If [ ConfigureGlobal, s3, !Sub 's3-${AWS::Region}' ]
        InstallPuTTYProduct:
          packages:
            msi:
              PuTTY: !Sub
                - https://${ProductsBucket}.${s3}.amazonaws.com/Windows/${PuTTYProductObject}
                - ProductsBucket: !ImportValue
                    Fn::Sub: ${BucketsStackName}-ProductsBucket
                  s3: !If [ ConfigureGlobal, s3, !Sub 's3-${AWS::Region}' ]
        SignalCloudFormation:
          commands:
            01-signal-success:
              command: powershell.exe -Command "Send-CloudFormationSuccess"
    Properties:
      ImageId: !Ref WindowsImage
      InstanceType: !FindInMap [ InstanceTypeMap, Bastion, !Ref EnvironmentType ]
      IamInstanceProfile: !Ref InstanceProfile
      KeyName: !Ref KeyName
      InstanceMonitoring: true
      SecurityGroups:
        - !Ref InstanceSecurityGroup
        - !If
            - ConfigureDirectoryIntegration
            - !ImportValue
                Fn::Sub: ${DirectoryStackName}-AdministratorSecurityGroup
            - !Ref 'AWS::NoValue'
        - !If
            - ConfigureActiveDirectoryIntegration
            - !ImportValue
                Fn::Sub: ${DirectoryStackName}-DomainMemberSecurityGroup
            - !Ref 'AWS::NoValue'
      BlockDeviceMappings:
        - DeviceName: /dev/sda1
          Ebs:
            VolumeSize: 64
            VolumeType: gp2
      UserData:
        Fn::Base64: !Sub |
          <script>
          cfn-init.exe --verbose --configsets All --stack ${AWS::StackId} --resource LaunchConfiguration --region ${AWS::Region}
          </script>
  AutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      LaunchConfigurationName: !Ref LaunchConfiguration
      VPCZoneIdentifier:
        - !ImportValue
            Fn::Sub: ${VPCStackName}-Public1SubnetA
        - !If
          - ConfigureMultiZone
          - !ImportValue
              Fn::Sub: ${VPCStackName}-Public1SubnetB
          - !Ref AWS::NoValue
      MinSize: !If [ ConfigureStandby, 0, !If [ ConfigureMultiZone, 2, 1 ]]
      MaxSize: !If [ ConfigureStandby, 0, !If [ ConfigureMultiZone, 2, 1 ]]
      DesiredCapacity: !If [ ConfigureStandby, 0, !If [ ConfigureMultiZone, 2, 1 ]]
      Cooldown: 300
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-${UtilityName}-Instance
          PropagateAtLaunch: true
    CreationPolicy:
      ResourceSignal:
        Count: !If [ ConfigureStandby, 0, !If [ ConfigureMultiZone, 2, 1 ]]
        Timeout: PT30M
    UpdatePolicy:
      AutoScalingRollingUpdate:
        MinInstancesInService: 1
        MaxBatchSize: 1
        PauseTime: PT30M
        WaitOnResourceSignals: true
  OnScheduledAction:
    Type: AWS::AutoScaling::ScheduledAction
    Properties:
      AutoScalingGroupName: !Ref AutoScalingGroup
      MinSize: !If [ ConfigureStandby, 0, !If [ ConfigureMultiZone, 2, 1 ]]
      MaxSize: !If [ ConfigureStandby, 0, !If [ ConfigureMultiZone, 2, 1 ]]
      DesiredCapacity: !If [ ConfigureStandby, 0, !If [ ConfigureMultiZone, 2, 1 ]]
      Recurrence: !Ref OnSchedule
    Condition: ConfigureOnSchedule
  OffScheduledAction:
    Type: AWS::AutoScaling::ScheduledAction
    Properties:
      AutoScalingGroupName: !Ref AutoScalingGroup
      MinSize: 0
      MaxSize: 0
      DesiredCapacity: 0
      Recurrence: !Ref OffSchedule
    Condition: ConfigureOffSchedule
  PublicServiceNameRecordSet:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !ImportValue
        Fn::Sub: ${VPCStackName}-PublicHostedZone
      Comment: !Sub DNS name for ${UtilityName} Instance
      Name: !Sub
        - ${UtilityDomain}.${VPCPublicDomain}.
        - VPCPublicDomain: !ImportValue
            Fn::Sub: ${VPCStackName}-VPCPublicDomain
      Type: A
      TTL: 900
      ResourceRecords:
        - !Ref EIPA
    Condition: ConfigureDomainName
  PublicServiceNameRecordSetA:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !ImportValue
        Fn::Sub: ${VPCStackName}-PublicHostedZone
      Comment: !Sub
        - DNS name for ${UtilityName} Instance in ${ZoneA}
        - ZoneA: !Select [ 0, !GetAZs '' ]
      Name: !Sub
        - ${UtilityDomain}a.${VPCPublicDomain}.
        - VPCPublicDomain: !ImportValue
            Fn::Sub: ${VPCStackName}-VPCPublicDomain
      Type: A
      TTL: 900
      ResourceRecords:
        - !Ref EIPA
    Condition: ConfigureDomainName&MultiZone
  PublicServiceNameRecordSetB:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !ImportValue
        Fn::Sub: ${VPCStackName}-PublicHostedZone
      Comment: !Sub
        - DNS name for ${UtilityName} Instance in ${ZoneB}
        - ZoneB: !Select [ 1, !GetAZs '' ]
      Name: !Sub
        - ${UtilityDomain}b.${VPCPublicDomain}.
        - VPCPublicDomain: !ImportValue
            Fn::Sub: ${VPCStackName}-VPCPublicDomain
      Type: A
      TTL: 900
      ResourceRecords:
        - !Ref EIPB
    Condition: ConfigureDomainName&MultiZone
Outputs:
  InstanceSecurityGroup:
    Description: The Instance SecurityGroup
    Value: !Ref InstanceSecurityGroup
    Export:
      Name: !Sub ${AWS::StackName}-InstanceSecurityGroup
  EIPA:
    Description: The Public Address of the Bastion in Availability Zone A
    Value: !Ref EIPA
    Condition: ConfigureStaticPublicAddress
  EIPB:
    Description: The Public Address of the Bastion in Availability Zone B
    Value: !Ref EIPB
    Condition: ConfigureStaticPublicAddress&MultiZone
  PublicServiceName:
    Description: The Public DNS ServiceName of the Bastion
    Value: !Sub
      - ${UtilityDomain}.${VPCPublicDomain}
      - VPCPublicDomain: !ImportValue
          Fn::Sub: ${VPCStackName}-VPCPublicDomain
    Condition: ConfigureDomainName
  PublicServiceNameA:
    Description: The Public DNS ServiceName of the Bastion in Availability Zone A
    Value: !Sub
      - ${UtilityDomain}a.${VPCPublicDomain}
      - VPCPublicDomain: !ImportValue
          Fn::Sub: ${VPCStackName}-VPCPublicDomain
    Condition: ConfigureDomainName&MultiZone
  PublicServiceNameB:
    Description: The Public DNS ServiceName of the Bastion in Availability Zone B
    Value: !Sub
      - ${UtilityDomain}b.${VPCPublicDomain}
      - VPCPublicDomain: !ImportValue
          Fn::Sub: ${VPCStackName}-VPCPublicDomain
    Condition: ConfigureDomainName&MultiZone
